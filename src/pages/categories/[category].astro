---
import { getCollection } from "astro:content";

/** Canonical category display names (must match config.ts enum) */
const CATEGORY_ORDER = [
  "Human Interest",
  "Space & Astronomy",
  "Health Sciences",
  "Arts & Culture",
  "Nature & Environment",
  "Education",
  "Innovation & Technology",
  "New Frontiers",
];

/**
 * Slugify helper for use in the template + runtime logic.
 * (Keep this at top-level for general use.)
 */
function categoryToSlug(category: string) {
  return String(category)
    .toLowerCase()
    .replace(/&/g, "and")
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/(^-|-$)/g, "");
}

/** Slug -> display name lookup */
const SLUG_TO_CATEGORY: Record<string, string> = Object.fromEntries(
  CATEGORY_ORDER.map((c) => [categoryToSlug(c), c])
);

export async function getStaticPaths() {
  // ✅ FIX: define slugify inside getStaticPaths so it’s always in-scope at build time
  const categoryToSlugLocal = (category: string) =>
    String(category)
      .toLowerCase()
      .replace(/&/g, "and")
      .replace(/[^a-z0-9]+/g, "-")
      .replace(/(^-|-$)/g, "");

  const categories = [
    "Human Interest",
    "Space & Astronomy",
    "Health Sciences",
    "Arts & Culture",
    "Nature & Environment",
    "Education",
    "Innovation & Technology",
    "New Frontiers",
  ];

  return categories.map((c) => ({
    params: { category: categoryToSlugLocal(c) },
  }));
}

const films = await getCollection("films");

const slug = Astro.params.category ?? "";
const category = SLUG_TO_CATEGORY[slug] ?? null;

const matches = category
  ? films
      .filter((f) => Array.isArray(f.data.categories) && f.data.categories.includes(category))
      .sort((a, b) => {
        const ay = a.data.year ?? 0;
        const by = b.data.year ?? 0;
        if (ay !== by) return by - ay;
        return a.data.title.localeCompare(b.data.title);
      })
  : [];

function embedUrl(film: any) {
  if (film.data.platform === "youtube") return `https://www.youtube.com/embed/${film.data.videoId}`;
  return `https://player.vimeo.com/video/${film.data.videoId}`;
}
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>{category ? `${category} — Browse Films` : "Browse Films — Bryan Nelson"}</title>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Manrope:wght@500;600;700&family=Source+Sans+3:wght@350;400;500;600&display=swap"
      rel="stylesheet"
    />
    <meta name="color-scheme" content="dark" />
  </head>

  <body>
    <div class="bg">
      <div class="vignette"></div>
      <div class="grain"></div>
    </div>

    <main class="wrap">
      <header class="top">
        <a class="brand" href="/">Bryan Nelson</a>

        <nav class="nav" aria-label="Primary navigation">
          <a class="navLink" href="/about">About</a>
          <a class="navLink active" href="/categories">Browse Films</a>
          <a class="navLink" href="/contact">Contact</a>
        </nav>
      </header>

      <section class="panel">
        <div class="panelHead">
          <div class="crumbs">
            <a href="/categories">Browse Films</a>
            <span>›</span>
            <span aria-current="page">{category ?? slug}</span>
          </div>

          <h1>{category ?? slug}</h1>
          <p class="lead">
            {category
              ? `${matches.length} film${matches.length === 1 ? "" : "s"} in this category.`
              : "Unknown category."}
          </p>
        </div>

        {category && matches.length ? (
          <div class="stack">
            {matches.map((film) => (
              <article class="filmBlock">
                <div class="player">
                  <iframe
                    src={embedUrl(film)}
                    title={film.data.title}
                    loading="lazy"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                    allowfullscreen
                  ></iframe>
                </div>

                <div class="meta">
                  <div class="titleRow">
                    <h2>{film.data.title}</h2>
                    {film.data.year ? <span class="year">{film.data.year}</span> : null}
                  </div>

                  <div class="cats">
                    {film.data.categories.map((c) => (
                      <a class="pill" href={`/categories/${categoryToSlug(c)}`}>{c}</a>
                    ))}
                  </div>

                  <div class="desc">
                    {film.body ? <div set:html={film.body} /> : null}
                  </div>
                </div>
              </article>
            ))}
          </div>
        ) : category ? (
          <p class="muted">No films found for this category yet.</p>
        ) : (
          <p class="muted">
            That category link isn’t recognized. Go back to{" "}
            <a class="inline" href="/categories">Browse Films</a>.
          </p>
        )}
      </section>

      <footer class="footer">
        <div class="footerLine"></div>
        <div class="footerInner">
          <div>
            <div class="footerName">Bryan Nelson</div>
            <div class="footerSub">Founder, Catachresis Productions</div>
          </div>

          <div class="footerLinks">
            <a href="/about">About</a>
            <a href="/categories">Browse Films</a>
            <a href="/contact">Contact</a>
          </div>
        </div>
      </footer>
    </main>

    <style>
      :global(body){margin:0;color:#fff;font-family:"Source Sans 3", ui-sans-serif, system-ui;background:#141414}
      h1,h2,.brand,.footerName{font-family:"Manrope", system-ui}

      .bg{position:fixed;inset:0;z-index:-1;background:#141414}
      .vignette{
        position:absolute;inset:-40px;
        background:
          radial-gradient(1100px 540px at 20% 10%, rgba(255,215,0,0.05), transparent 55%),
          radial-gradient(900px 500px at 90% 20%, rgba(80,170,255,0.04), transparent 55%),
          radial-gradient(1200px 900px at 50% 70%, rgba(255,255,255,0.02), transparent 60%),
          radial-gradient(ellipse at center, rgba(0,0,0,0) 35%, rgba(0,0,0,0.60) 100%);
      }
      .grain{
        position:absolute;inset:0;
        background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='160' height='160'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='160' height='160' filter='url(%23n)' opacity='.35'/%3E%3C/svg%3E");
        opacity:.075; mix-blend-mode:overlay; pointer-events:none;
      }

      .wrap{max-width:980px;margin:54px auto;padding:0 20px}

      .top{display:flex;justify-content:space-between;align-items:center;gap:14px;padding:14px 0 22px}
      .brand{color:#fff;text-decoration:none;font-weight:700;font-size:1.1rem}
      .nav{display:flex;gap:12px;flex-wrap:wrap}
      .navLink{
        color:rgba(255,255,255,0.75);
        text-decoration:none;
        border-bottom:1px solid rgba(255,255,255,0.16);
        padding-bottom:2px;
      }
      .navLink:hover{color:#fff;border-bottom-color:rgba(255,255,255,0.32)}
      .navLink.active{color:#fff;border-bottom-color:rgba(255,215,0,0.45)}

      .panel{
        border:1px solid rgba(255,255,255,0.08);
        border-radius:16px;
        background: linear-gradient(180deg, rgba(12,12,12,0.95), rgba(8,8,8,0.85));
        box-shadow: 0 18px 40px rgba(0,0,0,0.38);
        padding:18px 16px;
      }
      .panelHead{padding:6px 8px 16px}

      .crumbs{display:flex;gap:10px;align-items:center;color:rgba(255,255,255,0.60);font-size:.95rem}
      .crumbs a{color:rgba(255,215,0,0.90);text-decoration:none;border-bottom:1px solid rgba(255,215,0,0.22)}
      .crumbs a:hover{color:#fff;border-bottom-color:rgba(255,255,255,0.30)}

      h1{margin:10px 0 0;font-size:2rem;letter-spacing:-0.01em}
      .lead{margin:10px 0 0;color:rgba(255,255,255,0.70);line-height:1.6}

      .muted{color:rgba(255,255,255,0.62);padding:0 8px 10px}
      .inline{color:rgba(255,215,0,0.92)}

      .stack{display:flex;flex-direction:column;gap:18px;padding:0 8px 10px}

      .filmBlock{
        border:1px solid rgba(255,255,255,0.10);
        border-radius:16px;
        background: linear-gradient(180deg, rgba(16,16,16,0.92), rgba(10,10,10,0.86));
        overflow:hidden;
      }
      .player{aspect-ratio:16/9;background:#111}
      iframe{width:100%;height:100%;border:0;display:block}

      .meta{padding:14px}
      .titleRow{display:flex;justify-content:space-between;align-items:baseline;gap:12px}
      h2{margin:0;font-size:1.25rem}
      .year{color:rgba(255,255,255,0.60)}

      .cats{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
      .pill{
        display:inline-flex;align-items:center;
        padding:8px 12px;border-radius:999px;
        border:1px solid rgba(255,255,255,0.10);
        background: rgba(0,0,0,0.20);
        color:rgba(255,255,255,0.86);
        text-decoration:none;
        transition:transform .16s ease, border-color .16s ease;
      }
      .pill:hover{transform:translateY(-1px);border-color:rgba(255,255,255,0.18);color:#fff}

      .desc :global(p){color:rgba(255,255,255,0.70);line-height:1.7;margin:12px 0 0}

      .footer{margin:26px 0 10px}
      .footerLine{
        height:3px;margin:26px 0 18px;border-radius:99px;
        background: linear-gradient(90deg, rgba(20,20,20,0), rgba(255,255,255,0.20), rgba(20,20,20,0));
        box-shadow: 0 0 26px rgba(255,255,255,0.08);
      }
      .footerInner{display:flex;justify-content:space-between;gap:14px;align-items:flex-end;flex-wrap:wrap}
      .footerName{font-weight:700}
      .footerSub{color:rgba(255,255,255,0.58);margin-top:4px}
      .footerLinks{display:flex;gap:14px;flex-wrap:wrap}
      .footerLinks a{
        color:rgba(255,255,255,0.72);
        text-decoration:none;
        border-bottom:1px solid rgba(255,255,255,0.16);
        padding-bottom:2px;
      }
      .footerLinks a:hover{color:#fff;border-bottom-color:rgba(255,255,255,0.30)}
    </style>
  </body>
</html>