---
import { getCollection } from "astro:content";

export async function getStaticPaths() {
  const films = await getCollection("films");

  const eligible = films.filter((f) => {
    const inHomeSections =
      Array.isArray(f.data.homeSections) && f.data.homeSections.length > 0;
    return Boolean(f.data.featured || f.data.home || inHomeSections);
  });

  return eligible.map((film) => ({
    params: { slug: film.slug },
    props: { film },
  }));
}

const { film } = Astro.props;

const title = film.data.title;
const { platform, videoId } = film.data;

const embedUrl =
  platform === "youtube"
    ? `https://www.youtube-nocookie.com/embed/${videoId}`
    : `https://player.vimeo.com/video/${videoId}`;

function isMurrow(text) {
  return typeof text === "string" && text.toLowerCase().includes("murrow");
}
function awardColor(text) {
  return isMurrow(text) ? "#4aa3ff" : "#ffd700";
}
function getAwards(f) {
  if (Array.isArray(f.data.awards) && f.data.awards.length) return f.data.awards;
  if (typeof f.data.award === "string" && f.data.award.trim()) return [f.data.award.trim()];
  return [];
}

/** ---------------------------
 * Video Schema helpers
 * --------------------------*/
const SITE_ORIGIN = (Astro.site && Astro.site.origin) ? Astro.site.origin : "https://bryannelsonfilm.com";
const pageUrl = `${SITE_ORIGIN}/films/${film.slug}/`;

function absolutizeUrl(maybePath) {
  if (!maybePath || typeof maybePath !== "string") return undefined;
  if (maybePath.startsWith("http://") || maybePath.startsWith("https://")) return maybePath;
  const path = maybePath.startsWith("/") ? maybePath : `/${maybePath}`;
  return `${SITE_ORIGIN}${path}`;
}

function stripHtml(html) {
  if (typeof html !== "string") return "";
  return html.replace(/<[^>]*>/g, " ").replace(/\s+/g, " ").trim();
}

function truncate(text, n = 200) {
  if (!text) return "";
  if (text.length <= n) return text;
  return text.slice(0, n - 1).trimEnd() + "‚Ä¶";
}

// Prefer a dedicated description field if you have one, otherwise fall back to body text.
const descriptionRaw =
  (typeof film.data.logline === "string" && film.data.logline.trim()) ? film.data.logline.trim()
  : (typeof film.data.description === "string" && film.data.description.trim()) ? film.data.description.trim()
  : truncate(stripHtml(film.body ?? ""), 220);

const thumbnailUrl = absolutizeUrl(film.data.thumbnail);

// For YouTube/Vimeo we‚Äôll include both contentUrl and embedUrl.
// (Google is fine with either/both; embedUrl is especially useful.)
const contentUrl =
  platform === "youtube"
    ? `https://www.youtube.com/watch?v=${videoId}`
    : `https://vimeo.com/${videoId}`;

// If you only have a year, give Google a stable datePublished guess.
const datePublished =
  typeof film.data.year === "number" ? `${film.data.year}-01-01` : undefined;

const keywords =
  Array.isArray(film.data.categories) ? film.data.categories.join(", ") : undefined;

const videoSchema = {
  "@context": "https://schema.org",
  "@type": "VideoObject",
  name: title,
  description: descriptionRaw || undefined,
  thumbnailUrl: thumbnailUrl ? [thumbnailUrl] : undefined,
  uploadDate: datePublished, // best-effort if you only store year
  datePublished: datePublished,
  embedUrl,
  contentUrl,
  url: pageUrl,
  inLanguage: "en",
  keywords,
  // Light but strong identity signals:
  creator: {
    "@type": "Person",
    name: "Bryan Nelson",
    url: SITE_ORIGIN,
  },
  publisher: {
    "@type": "Organization",
    name: "Catachresis Productions",
    url: SITE_ORIGIN,
  },
};
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>{title}</title>

    {/* Canonical */}
    <link rel="canonical" href={pageUrl} />

    {/* Video schema (JSON-LD) */}
    <script type="application/ld+json" set:html={JSON.stringify(videoSchema)} />
  </head>
  <body>
    <main style="max-width:980px;margin:48px auto;padding:0 20px;color:#fff;">
      <a href="/" style="color:#bbb;text-decoration:none;">‚Üê Back</a>

      <h1 style="margin:14px 0 6px;">{title}</h1>

      <p style="margin:0 0 10px;color:#bbb;">
        {film.data.categories.join(" ‚Ä¢ ")}{film.data.year ? ` ‚Ä¢ ${film.data.year}` : ""}
      </p>

      {getAwards(film).length ? (
        <div style="margin:0 0 18px;font-size:.95rem;line-height:1.4;">
          {getAwards(film).map((a) => (
            <div style={`color:${awardColor(a)};font-weight:500;`}>
              üèÜ {a}
            </div>
          ))}
        </div>
      ) : null}

      <div style="position:relative;padding-top:56.25%;background:#111;border:1px solid #222;">
        <iframe
          src={embedUrl}
          title={title}
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
          allowfullscreen
          style="position:absolute;inset:0;width:100%;height:100%;border:0;"
        />
      </div>

      {film.body ? (
        <article style="margin-top:18px;color:#bbb;line-height:1.65;" set:html={film.body} />
      ) : null}
    </main>

    <style>
      :global(body){margin:0;background:#070707;font-family:ui-sans-serif,system-ui}
    </style>
  </body>
</html>